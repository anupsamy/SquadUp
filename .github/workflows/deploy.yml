name: Deploy to EC2

on:
  push:
    branches:
       - prod
    paths:
      - 'backend/**'
      - '.github/workflows/deploy.yml'

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mongo:
        image: mongo:7
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand({ping:1})' || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        working-directory: ./backend
        run: npm ci

      - name: Set up environment
        working-directory: ./backend
        run: |
          echo "MONGODB_URI=mongodb://localhost:27017/testdb" >> .env

      - name: Run tests
        working-directory: ./backend
        env:
          MONGODB_URI: mongodb://localhost:27017/testdb
        run: npm test

  deploy: 
    needs: test #if tests fail will not deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Copy filesto EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{secrets.EC2_HOST}}
          username: ${{secrets.EC2_USER}}
          key: ${{secrets.EC2_KEY}}
          source: "backend"
          target: "/home/ubuntu/SquadUp" 

      - name: Rebuild and Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{secrets.EC2_HOST}}
          username: ${{secrets.EC2_USER}}
          key: ${{secrets.EC2_KEY}}
          script: |
            cd /home/ubuntu/SquadUp/backend

            # Write secrets into .env
            cat > .env <<EOF
            PORT=${{secrets.PROD_PORT}}
            MONGODB_URI=${{secrets.PROD_DB_URI}}
            GOOGLE_CLIENT_ID=${{secrets.GOOGLE_CLIENT_ID}}
            JWT_SECRET=${{secrets.JWT_SECRET}}
            NEWS_API_KEY=${{secrets.NEWS_API_KEY}}
            FIREBASE_SERVICE_ACCOUNT_KEY=${{secrets.FIREBASE_SERVICE_ACCOUNT_KEY}}
            MAPS_API_KEY=${{secrets.MAPS_API_KEY}}
            EOF
            
            #give .env perms
            chmod 600 .env

            # build and run container
            docker-compose down

            docker-compose --env-file .env build
            docker-compose --env-file .env up -d